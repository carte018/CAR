#**
 * Copyright 2015 - 2019 Duke University
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License Version 2 as published by
    the Free Software Foundation.
 
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
 
    You should have received a copy of the GNU General Public License Version 2
    along with this program.  If not, see <https://www.gnu.org/licenses/old-licenses/gpl-2.0.txt>.

 *#
<h1>New Institutional Policy: $CarAdminUtils.localize($rhmi.getDisplayname(),$lang)</h2>

#if($successmsg)
<div class="message success">
	$successmsg
</div>
#end
#if($failmsg)
<div class="message error">
	$failmsg
</div>
#end

<div id="sidebar">
	<div class="content-section">
		<h2>Instructions</h2>
		<p>Meta policies control which other policies (institutional or user policies) take precedence in a given situation.</p>
		<p>Meta policies need not map one-to-one onto institutional policies.  The CAR system evaluates user and institutional policies separately, then evaluates meta policies to select which previously-evaluated policies are applied when rendering decisions.</p>
		<p>It is advisable to ensure that meta policies specifying "Follow User Consent" are in place for any situations in which institutional policy indicates a lawful basis of "Consent"</p>
	</div>
</div>


<div id="left">

	<form id="newopform" method="POST" action="#">
	
		<input type="hidden" name="formname" value="newopform">
	
		<div class="content-section">
			<div class="form-set">
				<h2>Policy Description</h2>
				<input type="text" name="policydescription" placeholder="Policy Description">
			</div>
		</div>
		<div class="content-section">
			<h2>Relying Parties</h2>
			<p>Apply this policy to:</p>
			<div class="form-set">
				<input type="radio" name="rpstrategy" value="allRPs" id="rpstrategy1" class="rpstrategy">
				<span id="selectedrpstrategy1" class="hidden inline">
				<label class="inline" for="rpstrategy1">All RPs of type <select name="specrptype1">#foreach($t in $supportedrptypes)<option value="$t">$t</option>#end</select></label>
				</span>
				<span id="unselectedrpstrategy1" class="inline">
					<label class="inline" for="rpstrategy1">All RPs</label>
				</span>
			</div>
			<div class="form-set">
				<input type="radio" name="rpstrategy" value="matchedRPs" id="rpstrategy2" class="rpstrategy">
				<span id="selectedrpstrategy2" class="hidden inline">
				<label class="inline" for="rpstrategy2">RPs where <input type="text" name="rpproperty" placeholder="RP Property Name"></label>
				<label class="inline">matches <input type="text" name="rpmatch" placeholder="Regular Expression"></label>
				</span>
				<span id="unselectedrpstrategy2" class="inline">
				<label class="inline" for="rpstrategy2">Only Some RPs</label>
				</span>
			</div>
			<div class="form-set">
				<input type="radio" name="rpstrategy" value="oneRP" id="rpstrategy3" class="rpstrategy">
				<span id="selectedrpstrategy3" class="hidden inline">
				<label class="inline" for="rpstrategy3">Specific RP <select name="specrptype">#foreach($t in $supportedrptypes)<option value="$t">$t</option>#end</select></label>
				<label class="inline"><select name="specrpid" style="width:100%;word-wrap:break-word;display:inline;">#foreach($i in $rpids)<option value="$i">$i</option>#end</select></label>
				</span>
				<span id="unselectedrpstrategy3" class="inline">
				<label class="inline" for="rpstrategy3">Only one RP</label>
				</span>
			</div>
		</div>
		
		<div class="content-section">
			<h2>Users</h2>
			<p>Apply this policy to:</p>
			<div class="form-set">
				<input type="radio" name="userstrategy" value="allUsers" id="userstrategy1" class="userstrategy">
				<span id="selecteduserstrategy1" class="hidden inline">
					<label class="inline" for="userstrategy1">Users with any value of <input type="text" name="userproperty1" placeholder="User Property Name"></label>
				</span>
				<span id="unselecteduserstrategy1" class="inline">
					<label class="inline" for="userstrategy1">All Users</label>
				</span>
			</div>
			<div class="form-set">
				<input type="radio" name="userstrategy" value="matchedUsers" id="userstrategy2" class="userstrategy">
				<span id="selecteduserstrategy2" class="hidden inline">
				<label class="inline" for="userstrategy2">Users with <input type="text" name="userproperty" placeholder="User Property Name"></label>
				<label class="inline">matching <input type="text" name="usermatch" placeholder="Regular Expression"></label>
				</span>
				<span id="unselecteduserstrategy2" class="inline">
				<label class="inline" for="userstrategy2">Only some users</label>
				</span>
			</div>
		</div>
		

		<div class="content-section">
			<h2>Directives</h2>
			#set($dirct=0)
			<input type="hidden" name="directivecount" id="directivecount" value="0">
			<table class="display full-width wrappingtable" id="directivetable">
				<thead>
					<tr>
						<th class="wrappingtd">Item Type</th>
						<th class="wrappingtd">Item Id</th>
						<th class="wrappingtd">Directive</th>
						<th class="wrappingtd">Value(s)</th>
						<th class="wrappingtd" style="width: 10%;"></th>
					</tr>
				</thead>
				<tbody id="dirtablebody">
					<tr id="row_a_$dirct">

					</tr>
					<tr id="row_b_$dirct">

					</tr>

				</tbody>
			</table>
			<br>
			<button class="active" id="addItemButton">Add Item<i class="fa button-icon-right fa-plus"></i></button>
		</div>
		<div class="content-section">
			<h2>All Other Items</h2>
			<div class="form-set">
				<label for="all-other-items-directive">Directive</label>
				<select name="all-other-items-directive" id="all-other-items-directive">
					<option value="continue">Continue applying lower-priority policies</option>
					<option value="COPSU">Follow user consent</option>
					<option value="ARPSI">Follow institutional policy</option>
				</select>
			</div>
		</div>    
		<button class="active" id="createButton">Create Policy<i class="fa button-icon-right fa-arrow-right"></i></button>
	</form>
</div>
		
		

<script type="text/javascript">
$(document).ready(function() {
	$("#addItemButton").click(function(e) {
		handleAddItemButton(e);
	});			
				
	$(".itypeselect").change(function(e) {
		handleitypechange(e);
	});	
	$(".itypeselect").trigger("change");
	
	$(".rpstrategy").change(function(e) {
		handlerpstratchange(e);
	});
	$(".userstrategy").change(function(e) {
		handleuserstratchange(e);
	});
	$(".directive").change(function(e) {
		handledirectivechange(e);
	});
	$(".aodirective").change(function(e) {
		handleaodirectivechange(e);
	});
	$(".addelem").click(function(e) {
		handleaddelem(e);
	});
	$(".delelem").click(function(e) {
		handledelelem(e);
	});

});

function handleaddelem(e) {
	e.preventDefault();
	tid = e.currentTarget.id;
	num = tid.replace("addelem_","");
	ac = parseInt($("#addcount_"+num).val());
	ac = ac + 1;
	$("#addcount_"+num).val(ac);
	$("#row_a_"+num).after('<tr id="row_a_'+num+'_'+ac+'"><td class="wrappingtd"><input type="hidden" name="itype_'+num+'_'+ac+'" value="'+$("#itype_"+num+" option:selected").val()+'">'+$("#itype_"+num+" option:selected").val()+'</td><td class="wrappingtd"><input type="hidden" name="iid_'+num+'_'+ac+'" value="'+$("#iid_"+num+" option:selected").val()+'">'+$("#iid_"+num+" option:selected").val()+'</td><td class="wrappingtd"><select name="directive_'+num+'_'+ac+'"><option value="COPSU">Follow user consent</option><option value="ARPSI">Follow institutional policy</option></select></td><td class="wrappingtd"><input type="text" name="values_'+num+'_'+ac+'" placeholder="Regular Expression" style="width: 100%;"></td><td class="wrappingtd" style="width: 10%;"><a href="#" id="delelem_'+num+'_'+ac+'" class="delelem"><i class="fa fa-trash"></i></a></td></tr>');
	$(".delelem").click(function(e) {
		handledelelem(e);
	});
}

function handledelelem(e) {
	e.preventDefault();
	tid = e.currentTarget.id;
	num = tid.replace("delelem_","");
	$("#"+tid).after('<input type="hidden" name="deleted_'+num+'" value="true">');
	$("#row_a_"+num).hide();
}


function handleaodirectivechange(e) {
	tid = e.target.id;
	n = tid.replace("directive_ao_","");
}

function handledirectivechange(e) {
	tid = e.target.id;
	n = tid.replace("directive_","");
}

function handlerpstratchange(e) {
	if ($("#"+e.target.id).val() == "allRPs") {
		$("#unselectedrpstrategy1").hide();
		$("#selectedrpstrategy1").show();
		$("#selectedrpstrategy2").hide();
		$("#unselectedrpstrategy2").show();
		$("#selectedrpstrategy3").hide();
		$("#unselectedrpstrategy3").show();
	} else if ($("#"+e.target.id).val() == "matchedRPs") {
		$("#unselectedrpstrategy1").show();
		$("#selectedrpstrategy1").hide();
		$("#selectedrpstrategy2").show();
		$("#unselectedrpstrategy2").hide();
		$("#selectedrpstrategy3").hide()
		$("#unselectedrpstrategy3").show();
	} else if ($("#"+e.target.id).val() == "oneRP") {
		$("#selectedrpstrategy1").hide();
		$("#unselectedrpstrategy1").show();
		$("#selectedrpstrategy2").hide();
		$("#unselectedrpstrategy2").show();
		$("#selectedrpstrategy3").show();
		$("#unselectedrpstrategy3").hide();
	} else {
		$("#selectedrpstrategy1").hide();
		$("#selectedrpstrategy2").hide();
		$("#selectedrpstrategy3").hide();
		$("#unselectedrpstrategy1").show();
		$("#unselectedrpstrategy2").show();
		$("#unselectedrpstrategy3").show();
	}
}

function handleuserstratchange(e) {
	if ($("#"+e.target.id).val() == "allUsers") {
		$("#selecteduserstrategy1").show();
		$("#unselecteduserstrategy1").hide();
		$("#selecteduserstrategy2").hide();
		$("#unselecteduserstrategy2").show();
	} else if ($("#"+e.target.id).val() == "matchedUsers") {
		$("#selecteduserstrategy1").hide();
		$("#unselecteduserstrategy1").show();
		$("#selecteduserstrategy2").show();
		$("#unselecteduserstrategy2").hide();
	} else {
		$("#selecteduserstrategy1").hide();
		$("#selecteduserstrategy2").hide();
		$("#unselecteduserstrategy1").show();
		$("#unselecteduserstrategy2").show();
	}
}

function handleAddItemButton(e) {
	e.preventDefault();
	n = Number($("#directivecount").val());
	n = n + 1;
	$("#directivecount").val(n);

	$("#dirtablebody").append(
						`<tr id="row_a_`+n+`">
						<td class="wrappingtd"><select class="itypeselect" id="itype_`+n+`" name="itype_`+n+`">#foreach($it in $supptypes.getInfotypes())<option value="$it">$it</option>#end</select></td>
						<td class="wrappingtd"><select name="iid_`+n+`" id="iid_`+n+`" style="width: 100%;"></select></td>
						<td class="wrappingtd"><select class="directive" name="directive_`+n+`" id="directive_`+n+`"><option value="COPSU">Follow user consent</option><option value="ARPSI">Follow institutional policy</option></select></td>
						<td class="wrappingtd"><input type="text" name="values_`+n+`" placeholder="Regular Expression" style="width: 100%;"></td>
						<td class="wrappingtd" style="width:10%;"><a href="#" id="addelem_`+n+`" class="addelem"><i class="fa fa-plus"></i></a><input type="hidden" id="addcount_`+n+`" name="addcount_`+n+`" value="0"></td>
					</tr>
					<tr id="row_b_`+n+`">
						<td colspan="2"></td>
						<td class="wrappingtd"><select class="aodirective" name="directive_ao_`+n+`" id="directive_ao_`+n+`"><option value="COPSU">Follow user consent</option><option value="ARPSI">Follow institutional policy</option></select></td>
						<td>All Other Values</td>	
						<td></td>					
					</tr>`);
					$(".itypeselect").change(function(e) {
						handleitypechange(e);
					});	
					$("#itype_"+n).trigger("change");
					$(".aodirective").change(function(e) {
						handleaodirectivechange(e);
					});
					$(".directive").change(function(e) {
						handledirectivechange(e);
					});
					$(".addelem").off("click");
					$(".addelem").click(function(e) {
						handleaddelem(e);
					});
					$(".delelem").off("click");
					$(".delelem").click(function(e) {
						handledelelem(e);
					});
}

function handleitypechange(e) {
				var items = {
					#foreach ($t in $typeidmap.keySet())
						"$t": [
							#foreach ($i in $typeidmap.get($t))
								"$i",
							#end
						],
					#end
				}
					tid = e.target.id;
					n = tid.replace("itype_","");
					$("#iid_"+n).empty();
					$(items[$("#"+tid).val()]).each(function(i,t) {
						$("#iid_"+n).append('<option value="'+t+'">'+t+'</option>');
					});
}

</script>

